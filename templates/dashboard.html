{% extends "base.html" %}

{% block content %}
<h1>Cultivation Dashboard</h1>
<div id="environmental-data">
    <h2>Environmental Data</h2>
    <p>Temperature: <span id="temperature"></span>Â°C</p>
    <p>Humidity: <span id="humidity"></span>%</p>
    <p>CO2 Level: <span id="co2-level"></span> ppm</p>
    <p>Last Updated: <span id="last-updated"></span></p>
    <button id="adjust-environment">Adjust Environment</button>
    <div id="adjustment-recommendations"></div>
</div>
<div id="chart-container">
    <canvas id="environmental-chart"></canvas>
</div>
<div id="plant-health-analysis">
    <h2>Plant Health Analysis</h2>
    <button id="plant-health-trends">Analyze Plant Health Trends</button>
    <div id="trends-result"></div>
</div>
<div id="image-analysis">
    <h2>Advanced Plant Image Analysis</h2>
    <input type="file" id="image-upload" accept="image/*">
    <div id="analysis-result"></div>
</div>
<div id="yield-prediction">
    <h2>Yield Prediction</h2>
    <input type="text" id="batch-id" placeholder="Enter Batch ID">
    <button id="predict-yield">Predict Yield</button>
    <div id="yield-result"></div>
</div>
<div id="chatbot">
    <h2>Advanced Cultivation Assistant</h2>
    <div id="chat-messages"></div>
    <input type="text" id="user-input" placeholder="Ask a question about plant health or yield...">
    <button id="send-message">Send</button>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/image_analysis.js') }}"></script>
<script src="{{ url_for('static', filename='js/chatbot.js') }}"></script>
<script src="{{ url_for('static', filename='js/yield_prediction.js') }}"></script>
<script>
    fetch('/api/dashboard_data')
        .then(response => response.json())
        .then(data => {
            document.getElementById('currentPhase').textContent = data.current_phase;
            document.getElementById('vpdBounds').textContent = `Lower: ${data.vpd_bounds[0]} kPa, Upper: ${data.vpd_bounds[1]} kPa`;

            const ctx = document.getElementById('vpdChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.environmental_data.map(d => new Date(d.timestamp).toLocaleString()),
                    datasets: [{
                        label: 'VPD (kPa)',
                        data: data.environmental_data.map(d => d.vpd),
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1,
                        pointBackgroundColor: data.environmental_data.map(d => d.is_day ? 'yellow' : 'blue')
                    }, {
                        label: 'Lower Bound',
                        data: data.environmental_data.map(() => data.vpd_bounds[0]),
                        borderColor: 'rgba(255, 99, 132, 0.5)',
                        borderDash: [5, 5],
                        fill: false
                    }, {
                        label: 'Upper Bound',
                        data: data.environmental_data.map(() => data.vpd_bounds[1]),
                        borderColor: 'rgba(255, 99, 132, 0.5)',
                        borderDash: [5, 5],
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'VPD (kPa)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date/Time'
                            }
                        }
                    }
                }
            });
        });
</script>
{% endblock %}
